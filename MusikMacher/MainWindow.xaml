<Window x:Class="MusikMacher.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
        xmlns:local="clr-namespace:MusikMacher"
        xmlns:localConverter="clr-namespace:MusikMacher.converter"
        mc:Ignorable="d"
        Title="Lorus Musik Macher" Height="450" Width="800">
  <Window.Resources>
    <localConverter:SecondsToTimeStringConverter x:Key="SecondsToTimeStringConverter"/>
    <localConverter:TagListConverter x:Key="TagListConverter"/>
    
    <!-- time slider style -->
    <Style x:Key="SliderStyle" TargetType="{x:Type Slider}">
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="{x:Type Slider}">
            <Grid VerticalAlignment="Center">
              <Border x:Name="borderBackgroundForClick" Margin="6,0" Height="20" Background="Transparent" />
              <Border x:Name="borderBackground" Margin="6,0" Height="4" Background="#8a8a8a" CornerRadius="2" />
              <Canvas Margin="0,-4,0,0" VerticalAlignment="Center">
                <Border x:Name="PART_SelectionRange" HorizontalAlignment="Left" Margin="-4,0,0,0" Height="4" CornerRadius="2" Background="{TemplateBinding Foreground}" />
              </Canvas>
              <Track x:Name="PART_Track">
                <Track.Thumb>
                  <Thumb Width="20" Height="20">
                    <Thumb.Style>
                      <Style TargetType="Thumb">
                        <Setter Property="Template">
                          <Setter.Value>
                            <ControlTemplate TargetType="Thumb">
                              <Border Width="20" Height="20" Background="#d55223" CornerRadius="10" BorderBrush="White" BorderThickness="5">
                                <Border.Effect>
                                  <DropShadowEffect ShadowDepth="1" Color="Black" Opacity="0.5"/>
                                </Border.Effect>
                              </Border>
                            </ControlTemplate>
                          </Setter.Value>
                        </Setter>
                      </Style>
                    </Thumb.Style>
                  </Thumb>
                </Track.Thumb>
              </Track>
            </Grid>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
      <Setter Property="IsSelectionRangeEnabled" Value="True" />
      <Setter Property="SelectionStart" Value="{Binding Minimum, RelativeSource={RelativeSource Self}}" />
      <Setter Property="SelectionEnd" Value="{Binding Value, RelativeSource={RelativeSource Self}}" />
      <Setter Property="Foreground" Value="#c94617" />
    </Style>

  </Window.Resources>
  <Window.InputBindings>
    <KeyBinding Key="Space" Command="{Binding SpaceKeyPressedCommand}" />
  </Window.InputBindings>
  <Grid>
    <TabControl HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
      <TabItem Header="Browse">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>

          <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="200"/>
              <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- tag selction -->
            <Grid Grid.Column="0">
              <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>
              <ListBox Grid.Row="0"
                       x:Name="listBox"
                       ItemsSource="{Binding Tags}"
                       SelectedItem="{Binding Path=SelectedTag}"
                       >
                <ListBox.ItemContainerStyle>
                  <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"></Setter>
                  </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ContextMenu>
                  <ContextMenu>
                    <MenuItem Header="Rename" Click="MenuItem_Rename"/>
                  </ContextMenu>
                </ListBox.ContextMenu>
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <CheckBox IsChecked="{Binding IsChecked}" VerticalAlignment="Center" Content="{Binding Name}" HorizontalContentAlignment="Stretch"
                                                     AllowDrop="True"
                       DragEnter="Tag_DragEnter"
                       DragOver="Tag_DragOver"
                       Drop="Tag_Drop"/>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <Button Grid.Row="1" Command="{Binding Path=AddTagCommand}">Add Tag</Button>
            </Grid>
            <Grid Grid.Column="1" >
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>
              <!-- search see: https://stackoverflow.com/a/21672408 -->
              <Grid Grid.Row="0">
                <TextBox Text="{Binding Search, UpdateSourceTrigger=PropertyChanged}" x:Name="SearchTermTextBox" Margin="5"/>
                <TextBlock IsHitTestVisible="False" Text="Enter Search Term Here" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="10,0,0,0" Foreground="DarkGray">
                  <TextBlock.Style>
                    <Style TargetType="{x:Type TextBlock}">
                      <Setter Property="Visibility" Value="Collapsed"/>
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding Text, ElementName=SearchTermTextBox}" Value="">
                          <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </TextBlock.Style>
                </TextBlock>
              </Grid>
              <!-- data -->
              <DataGrid 
                x:Name="dataGrid" 
                Grid.Row="1" 
                ItemsSource="{Binding TracksView}" 
                SelectedItem="{Binding Path=Player.currentTrack, Mode=TwoWay}"
                SelectionChanged="DataGrid_SelectionChanged"
                AutoGenerateColumns="False"
                IsReadOnly="True"
                PreviewMouseLeftButtonDown="DataGrid_PreviewMouseLeftButtonDown"
                PreviewMouseMove="DataGrid_PreviewMouseMove"
                CanUserDeleteRows="False"
                >
                <DataGrid.InputBindings>
                  <KeyBinding Key="Space" Command="{Binding SpaceKeyPressedCommand}" />
                </DataGrid.InputBindings>
                <DataGrid.ContextMenu>
                  <ContextMenu>
                    <MenuItem Header="Delete track" Click="DataGrid_Delete"/>
                  </ContextMenu>
                </DataGrid.ContextMenu>
                <DataGrid.Columns>
                  <DataGridTextColumn Header="Name" Binding="{Binding name}" />
                  <DataGridTextColumn Header="Length" Binding="{Binding Path=length, Converter={StaticResource SecondsToTimeStringConverter}}" />
                  <DataGridTextColumn Header="Creation time" Binding="{Binding creationTime, StringFormat='dd.MM.yyyy'}" />
                  <DataGridTextColumn Header="Tags" Binding="{Binding Path=Tags, Converter={StaticResource TagListConverter}}" />
                  <!-- Add more columns here if needed -->
                </DataGrid.Columns>
              </DataGrid>
              <TextBlock Grid.Row="2" HorizontalAlignment="Right" Margin="10,5,5,0">
                <Run Text="Tracks in view: " />
                <Run Text="{Binding TrackCount, Mode=OneWay}" />
              </TextBlock>
            </Grid>
          </Grid>


          <StackPanel Grid.Row="1">
            <Label Content="{Binding Path=Player.currentTrack.name}"/>
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <Label Grid.Column="0" Content="{Binding  Path=Player.Position, Converter={StaticResource SecondsToTimeStringConverter}}"/>
              <local:TimeSlider 
                Focusable="False" 
                Grid.Column="1" 
                IsMoveToPointEnabled="True" 
                HorizontalAlignment="Stretch" 
                Maximum="{Binding Path=Player.Length}" 
                Value="{Binding Path=Player.Position}"
                SelectionEnd="{Binding Path=Player.Position}"
                Style="{StaticResource SliderStyle}"
                IsSelectionRangeEnabled="True"
                >
              </local:TimeSlider>
              <Label Grid.Column="2" Content="{Binding  Path=Player.Length, Converter={StaticResource SecondsToTimeStringConverter}}"/>
            </Grid>
            <StackPanel Orientation="Horizontal">
              <Button Content="Play" Command="{Binding Path=Player.PlayCommand}" IsEnabled="{Binding !IsPlaying}"/>
              <Button Content="Pause" Command="{Binding Path=Player.PauseCommand}" IsEnabled="{Binding IsPlaying}"/>
              <Button Content="Stop" Command="{Binding Path=Player.StopCommand}"/>
            </StackPanel>
          </StackPanel>
        </Grid>
      </TabItem>
      <TabItem Header="Settings">
        <Grid Background="#FFE5E5E5">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          <Label  Grid.Row="0">
            Path to search
          </Label>
          <TextBox Grid.Row="1" Text="{Binding Path=dataLocation}"/>
          <CheckBox Grid.Row="2" Content="Import subfolders" IsChecked="{Binding Path=ImportSubfolders}"/>
          <Button Grid.Row="3" Content="Load Data" Command="{Binding LoadDataCommand}"/>
          <ScrollViewer Grid.Row="4">
            <TextBlock Text="{Binding Path=loadingLog}"/>
          </ScrollViewer>
          <CheckBox Grid.Row="5" Content="Tracks need to have all selected tags. (If deselected one suffices)" IsChecked="{Binding Path=AndTags}"/>
        </Grid>
      </TabItem>
    </TabControl>

  </Grid>
</Window>

